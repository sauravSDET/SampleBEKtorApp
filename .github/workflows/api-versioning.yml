name: ðŸ”„ API Versioning & Contract Drift Prevention

on:
  pull_request:
    paths:
      - 'src/main/resources/openapi/**'
      - '**/proto/**'
      - '**/*api-models/**'
  push:
    branches: [main]
    paths:
      - 'src/main/resources/openapi/**'
      - '**/proto/**'
      - '**/*api-models/**'

env:
  BUF_TOKEN: ${{ secrets.BUF_TOKEN }}
  OPENAPI_GENERATOR_VERSION: 7.1.0

jobs:
  # ðŸ“‹ OpenAPI Contract Validation
  openapi-validation:
    name: ðŸ“‹ OpenAPI Contract Validation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install OpenAPI Tools
        run: |
          npm install -g @apidevtools/swagger-parser
          npm install -g swagger-diff
          npm install -g redoc-cli

      - name: âœ… Validate OpenAPI Specification
        run: |
          swagger-parser validate src/main/resources/openapi/api.yaml

      - name: ðŸ”„ Check Breaking Changes (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Get the main branch version
          git fetch origin main:main
          git checkout main -- src/main/resources/openapi/api.yaml || echo "No previous API spec found"
          
          if [ -f src/main/resources/openapi/api.yaml ]; then
            mv src/main/resources/openapi/api.yaml src/main/resources/openapi/api-main.yaml
            git checkout HEAD -- src/main/resources/openapi/api.yaml
            
            # Check for breaking changes
            swagger-diff src/main/resources/openapi/api-main.yaml src/main/resources/openapi/api.yaml --check
          else
            echo "âœ… New API specification - no breaking changes to check"
          fi

      - name: ðŸ“Š Generate API Documentation
        run: |
          redoc-cli build src/main/resources/openapi/api.yaml --output api-docs.html

      - name: ðŸ“‹ Upload API Documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: api-docs.html

  # ðŸ”„ Protobuf Schema Validation
  protobuf-validation:
    name: ðŸ”„ Protobuf Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup buf CLI
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Lint Protobuf Files
        run: |
          if [ -d "proto" ]; then
            buf lint proto
          else
            echo "ðŸ“ No protobuf files found, creating example structure"
            mkdir -p proto/events/v1
            cat > proto/buf.yaml << EOF
          version: v1
          breaking:
            use:
              - FILE
          lint:
            use:
              - DEFAULT
          EOF
          fi

      - name: ðŸ”„ Check Schema Breaking Changes
        if: github.event_name == 'pull_request'
        run: |
          if [ -d "proto" ]; then
            buf breaking proto --against '.git#branch=main'
          else
            echo "âœ… No protobuf files to check for breaking changes"
          fi

      - name: ðŸ“Š Generate Protobuf Documentation
        if: always()
        run: |
          if [ -d "proto" ]; then
            buf generate proto
          fi

  # ðŸ·ï¸ API Version Management
  api-versioning:
    name: ðŸ·ï¸ API Version Management
    runs-on: ubuntu-latest
    needs: [openapi-validation, protobuf-validation]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ·ï¸ Extract API Version
        id: api-version
        run: |
          # Extract version from OpenAPI spec
          VERSION=$(grep 'version:' src/main/resources/openapi/api.yaml | head -1 | cut -d':' -f2 | tr -d ' "')
          echo "api-version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Detected API Version: $VERSION"

      - name: ðŸ”„ Check if Version Changed
        id: version-check
        run: |
          git fetch origin main:main || true
          PREV_VERSION=$(git show main:src/main/resources/openapi/api.yaml 2>/dev/null | grep 'version:' | head -1 | cut -d':' -f2 | tr -d ' "' || echo "0.0.0")
          CURR_VERSION="${{ steps.api-version.outputs.api-version }}"
          
          echo "previous-version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "current-version=$CURR_VERSION" >> $GITHUB_OUTPUT
          
          if [ "$PREV_VERSION" != "$CURR_VERSION" ]; then
            echo "version-changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ API Version changed from $PREV_VERSION to $CURR_VERSION"
          else
            echo "version-changed=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ API Version unchanged: $CURR_VERSION"
          fi

      - name: ðŸ—ï¸ Generate Versioned API Models
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          ./gradlew generateApiModels -PapiVersion=${{ steps.api-version.outputs.api-version }}

      - name: ðŸ·ï¸ Create API Version Tag
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "api-v${{ steps.api-version.outputs.api-version }}" -m "API Version ${{ steps.api-version.outputs.api-version }}"
          git push origin "api-v${{ steps.api-version.outputs.api-version }}"

  # ðŸ§ª Contract Testing with Pact
  contract-testing:
    name: ðŸ§ª Contract Testing (Consumer-Driven)
    runs-on: ubuntu-latest
    needs: [openapi-validation]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ§ª Run Provider Contract Tests
        run: ./gradlew contractTest

      - name: ðŸ“Š Publish Pact Results
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ“Š Publishing contract test results to Pact Broker"
          # This would integrate with your Pact Broker
          ./gradlew pactPublish

      - name: ðŸ“‹ Upload Contract Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: contract-test-results
          path: build/reports/pact/

  # ðŸ“ˆ API Compatibility Report
  compatibility-report:
    name: ðŸ“ˆ API Compatibility Report
    runs-on: ubuntu-latest
    needs: [openapi-validation, protobuf-validation, contract-testing]
    if: always()
    steps:
      - name: ðŸ“Š Generate Compatibility Summary
        run: |
          echo "## ðŸ”„ API Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAPI Validation | ${{ needs.openapi-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Schema validation completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Protobuf Validation | ${{ needs.protobuf-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Event schema validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Contract Testing | ${{ needs.contract-testing.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Consumer-driven contracts |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Key Validations" >> $GITHUB_STEP_SUMMARY
          echo "- **Backward Compatibility**: Ensured no breaking changes" >> $GITHUB_STEP_SUMMARY
          echo "- **Schema Evolution**: Protobuf compatibility maintained" >> $GITHUB_STEP_SUMMARY
          echo "- **Contract Adherence**: Consumer expectations met" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Management**: Automatic versioning on changes" >> $GITHUB_STEP_SUMMARY
