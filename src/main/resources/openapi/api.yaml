openapi: 3.0.3
info:
  title: Sample Ktor Backend API
  description: |
    A comprehensive Ktor backend sample with Event-Driven and Domain-Driven Design.
    
    ## API Versioning
    This API supports versioning through multiple strategies:
    - **Header-based**: Use `API-Version: 1.1` header (recommended)
    - **Path-based**: Use `/api/v1/` or `/api/v2/` in URL path
    - **Query parameter**: Use `?version=1.1` query parameter
    
    ## Breaking Changes Policy
    - Major version changes (1.0 → 2.0) may include breaking changes
    - Minor version changes (1.0 → 1.1) are backwards compatible
    - Deprecated versions will be supported for at least 6 months
    
    ## Contract Validation
    All requests and responses are validated against this OpenAPI specification.
  version: 1.1.0
  contact:
    name: API Support
    email: support@example.com
    url: https://docs.example.com/api
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api-staging.example.com
    description: Staging server
  - url: https://api.example.com
    description: Production server

# Global security schemes
security:
  - ApiKeyAuth: []
  - BearerAuth: []

# Request/Response validation headers
x-validation-enabled: true
x-version-strategy: header-first

paths:
  # Health and system endpoints
  /health:
    get:
      summary: Health check endpoint
      description: Returns the current health status of the API and its dependencies
      operationId: healthCheck
      tags:
        - System
      security: [] # No auth required for health check
      responses:
        '200':
          description: Service is healthy
          headers:
            X-API-Version:
              description: Current API version
              schema:
                type: string
                example: "1.1"
            X-Response-Time:
              description: Response time in milliseconds
              schema:
                type: integer
                example: 45
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Users API with full CRUD operations
  /api/v1/users:
    get:
      summary: List all users with pagination and filtering
      description: Retrieve a paginated list of users with optional filtering capabilities
      operationId: getUsers
      tags:
        - Users
      parameters:
        - name: page
          in: query
          description: Page number (0-based)
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
        - name: size
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
            example: 10
        - name: email
          in: query
          description: Filter users by email (partial match)
          required: false
          schema:
            type: string
            format: email
            example: "john@example.com"
        - name: status
          in: query
          description: Filter users by status
          required: false
          schema:
            $ref: '#/components/schemas/UserStatus'
      responses:
        '200':
          description: List of users retrieved successfully
          headers:
            X-Total-Count:
              description: Total number of users matching the criteria
              schema:
                type: integer
            X-Page-Count:
              description: Total number of pages
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsersListResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      summary: Create a new user
      description: Create a new user with email validation and duplicate checking
      operationId: createUser
      tags:
        - Users
      requestBody:
        required: true
        description: User creation data
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
            examples:
              validUser:
                summary: Valid user creation request
                value:
                  email: "john.doe@example.com"
                  firstName: "John"
                  lastName: "Doe"
      responses:
        '201':
          description: User created successfully
          headers:
            Location:
              description: URL of the created user
              schema:
                type: string
                format: uri
                example: "/api/v1/users/123e4567-e89b-12d3-a456-426614174000"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid request data or validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '409':
          description: User with this email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/users/{userId}:
    parameters:
      - name: userId
        in: path
        required: true
        description: Unique identifier for the user
        schema:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"

    get:
      summary: Get user by ID
      description: Retrieve a specific user by their unique identifier
      operationId: getUserById
      tags:
        - Users
      responses:
        '200':
          description: User found and returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    put:
      summary: Update user profile
      description: Update user information (partial updates supported)
      operationId: updateUser
      tags:
        - Users
      requestBody:
        required: true
        description: User update data (all fields optional)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    delete:
      summary: Delete user
      description: Soft delete a user (marks as inactive)
      operationId: deleteUser
      tags:
        - Users
      responses:
        '204':
          description: User deleted successfully
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  # Orders API with full lifecycle management
  /api/v1/orders:
    get:
      summary: List orders with filtering
      description: Retrieve orders with comprehensive filtering and sorting options
      operationId: getOrders
      tags:
        - Orders
      parameters:
        - name: userId
          in: query
          description: Filter orders by user ID
          required: false
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          description: Filter orders by status
          required: false
          schema:
            $ref: '#/components/schemas/OrderStatus'
        - name: fromDate
          in: query
          description: Filter orders from this date (inclusive)
          required: false
          schema:
            type: string
            format: date-time
        - name: toDate
          in: query
          description: Filter orders to this date (inclusive)
          required: false
          schema:
            type: string
            format: date-time
        - name: sortBy
          in: query
          description: Sort orders by field
          required: false
          schema:
            type: string
            enum: [createdAt, updatedAt, totalAmount]
            default: createdAt
        - name: sortOrder
          in: query
          description: Sort order
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: List of orders
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      summary: Create a new order
      description: Create a new order with items and automatic total calculation
      operationId: createOrder
      tags:
        - Orders
      requestBody:
        required: true
        description: Order creation data
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
            examples:
              singleItem:
                summary: Order with single item
                value:
                  userId: "123e4567-e89b-12d3-a456-426614174000"
                  items:
                    - productId: "456e7890-e89b-12d3-a456-426614174001"
                      quantity: 2
                      price: 25.50
              multipleItems:
                summary: Order with multiple items
                value:
                  userId: "123e4567-e89b-12d3-a456-426614174000"
                  items:
                    - productId: "456e7890-e89b-12d3-a456-426614174001"
                      quantity: 2
                      price: 25.50
                    - productId: "456e7890-e89b-12d3-a456-426614174002"
                      quantity: 1
                      price: 15.75
      responses:
        '201':
          description: Order created successfully
          headers:
            Location:
              description: URL of the created order
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Invalid order data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
        '404':
          description: Referenced user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/orders/{orderId}:
    parameters:
      - name: orderId
        in: path
        required: true
        description: Unique identifier for the order
        schema:
          type: string
          format: uuid

    get:
      summary: Get order by ID
      description: Retrieve a specific order with all details
      operationId: getOrderById
      tags:
        - Orders
      responses:
        '200':
          description: Order found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/orders/{orderId}/status:
    parameters:
      - name: orderId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      summary: Update order status
      description: |
        Update order status following business rules:
        - PENDING → CONFIRMED, CANCELLED
        - CONFIRMED → PROCESSING, CANCELLED
        - PROCESSING → SHIPPED, CANCELLED
        - SHIPPED → DELIVERED
        - DELIVERED, CANCELLED are terminal states
      operationId: updateOrderStatus
      tags:
        - Orders
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateOrderStatusRequest'
      responses:
        '200':
          description: Order status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

components:
  # Security schemes
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication

  # Reusable responses
  responses:
    UnauthorizedError:
      description: Authentication required
      headers:
        WWW-Authenticate:
          schema:
            type: string
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  # Schema definitions with comprehensive validation
  schemas:
    # User schemas
    UserResponse:
      type: object
      required:
        - id
        - email
        - firstName
        - lastName
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
          example: "123e4567-e89b-12d3-a456-426614174000"
        email:
          type: string
          format: email
          description: User's email address
          example: "john.doe@example.com"
          maxLength: 255
        firstName:
          type: string
          description: User's first name
          example: "John"
          minLength: 1
          maxLength: 100
          pattern: "^[a-zA-Z\\s'-]+$"
        lastName:
          type: string
          description: User's last name
          example: "Doe"
          minLength: 1
          maxLength: 100
          pattern: "^[a-zA-Z\\s'-]+$"
        status:
          $ref: '#/components/schemas/UserStatus'
        createdAt:
          type: string
          format: date-time
          description: User creation timestamp
          example: "2023-01-01T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: User last update timestamp
          example: "2023-01-01T10:00:00Z"

    CreateUserRequest:
      type: object
      required:
        - email
        - firstName
        - lastName
      properties:
        email:
          type: string
          format: email
          description: User's email address (must be unique)
          example: "john.doe@example.com"
          maxLength: 255
        firstName:
          type: string
          description: User's first name
          example: "John"
          minLength: 1
          maxLength: 100
          pattern: "^[a-zA-Z\\s'-]+$"
        lastName:
          type: string
          description: User's last name
          example: "Doe"
          minLength: 1
          maxLength: 100
          pattern: "^[a-zA-Z\\s'-]+$"

    UpdateUserRequest:
      type: object
      description: User update request (all fields optional for partial updates)
      properties:
        firstName:
          type: string
          description: User's first name
          example: "John"
          minLength: 1
          maxLength: 100
          pattern: "^[a-zA-Z\\s'-]+$"
        lastName:
          type: string
          description: User's last name
          example: "Doe"
          minLength: 1
          maxLength: 100
          pattern: "^[a-zA-Z\\s'-]+$"
        status:
          $ref: '#/components/schemas/UserStatus'

    UsersListResponse:
      type: object
      required:
        - items
        - totalCount
        - page
        - size
        - totalPages
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/UserResponse'
          description: List of users for current page
        totalCount:
          type: integer
          minimum: 0
          description: Total number of users matching criteria
          example: 150
        page:
          type: integer
          minimum: 0
          description: Current page number (0-based)
          example: 0
        size:
          type: integer
          minimum: 1
          description: Number of items per page
          example: 10
        totalPages:
          type: integer
          minimum: 0
          description: Total number of pages
          example: 15

    UserStatus:
      type: string
      enum:
        - ACTIVE
        - INACTIVE
        - SUSPENDED
        - PENDING_VERIFICATION
      description: User account status
      example: "ACTIVE"

    # Order schemas
    OrderResponse:
      type: object
      required:
        - id
        - userId
        - items
        - status
        - totalAmount
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique order identifier
          example: "456e7890-e89b-12d3-a456-426614174001"
        userId:
          type: string
          format: uuid
          description: ID of the user who placed the order
          example: "123e4567-e89b-12d3-a456-426614174000"
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemResponse'
          minItems: 1
          description: List of items in the order
        status:
          $ref: '#/components/schemas/OrderStatus'
        totalAmount:
          type: number
          format: double
          minimum: 0
          description: Total order amount (calculated automatically)
          example: 51.75
        createdAt:
          type: string
          format: date-time
          description: Order creation timestamp
          example: "2023-01-01T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Order last update timestamp
          example: "2023-01-01T10:00:00Z"

    CreateOrderRequest:
      type: object
      required:
        - userId
        - items
      properties:
        userId:
          type: string
          format: uuid
          description: ID of the user placing the order
          example: "123e4567-e89b-12d3-a456-426614174000"
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemRequest'
          minItems: 1
          maxItems: 50
          description: List of items to order

    UpdateOrderStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          $ref: '#/components/schemas/OrderStatus'
        reason:
          type: string
          description: Optional reason for status change
          maxLength: 500
          example: "Customer requested cancellation"

    OrderItemRequest:
      type: object
      required:
        - productId
        - quantity
        - price
      properties:
        productId:
          type: string
          format: uuid
          description: ID of the product being ordered
          example: "789e0123-e89b-12d3-a456-426614174002"
        quantity:
          type: integer
          minimum: 1
          maximum: 999
          description: Quantity of the product
          example: 2
        price:
          type: number
          format: double
          minimum: 0
          description: Unit price of the product
          example: 25.50

    OrderItemResponse:
      allOf:
        - $ref: '#/components/schemas/OrderItemRequest'
        - type: object
          required:
            - subtotal
          properties:
            subtotal:
              type: number
              format: double
              minimum: 0
              description: Subtotal for this item (quantity × price)
              example: 51.00

    OrderStatus:
      type: string
      enum:
        - PENDING
        - CONFIRMED
        - PROCESSING
        - SHIPPED
        - DELIVERED
        - CANCELLED
      description: |
        Order status with allowed transitions:
        - PENDING → CONFIRMED, CANCELLED
        - CONFIRMED → PROCESSING, CANCELLED  
        - PROCESSING → SHIPPED, CANCELLED
        - SHIPPED → DELIVERED
        - DELIVERED, CANCELLED (terminal states)
      example: "PENDING"

    # System schemas
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
        - version
        - checks
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall system health status
          example: "healthy"
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
          example: "2023-01-01T10:00:00Z"
        version:
          type: string
          description: API version
          example: "1.1.0"
        uptime:
          type: integer
          description: System uptime in seconds
          example: 86400
        checks:
          type: object
          description: Individual component health checks
          properties:
            database:
              $ref: '#/components/schemas/HealthCheck'
            kafka:
              $ref: '#/components/schemas/HealthCheck'
            cache:
              $ref: '#/components/schemas/HealthCheck'

    HealthCheck:
      type: object
      required:
        - status
        - responseTime
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          example: "healthy"
        responseTime:
          type: integer
          description: Response time in milliseconds
          example: 15
        message:
          type: string
          description: Additional status information
          example: "Connection successful"

    # Error schemas
    ErrorResponse:
      type: object
      required:
        - message
        - code
        - timestamp
      properties:
        message:
          type: string
          description: Human-readable error message
          example: "User not found"
        code:
          type: string
          description: Machine-readable error code
          example: "USER_NOT_FOUND"
        timestamp:
          type: string
          format: date-time
          description: Error occurrence timestamp
          example: "2023-01-01T10:00:00Z"
        traceId:
          type: string
          description: Request trace ID for debugging
          example: "abc123def456"
        details:
          type: object
          description: Additional error context
          additionalProperties: true

    ValidationErrorResponse:
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          required:
            - validationErrors
          properties:
            validationErrors:
              type: array
              items:
                $ref: '#/components/schemas/ValidationError'
              description: List of field validation errors

    ValidationError:
      type: object
      required:
        - field
        - message
        - code
      properties:
        field:
          type: string
          description: Field name that failed validation
          example: "email"
        message:
          type: string
          description: Human-readable validation error
          example: "Invalid email format"
        code:
          type: string
          description: Machine-readable validation error code
          example: "INVALID_EMAIL_FORMAT"
        value:
          description: The invalid value that was provided
          example: "not-an-email"
